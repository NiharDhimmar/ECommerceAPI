<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostgreSQL UI with Flask</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #333;
        }
        /* Button styling for better aesthetics */
        .btn {
            @apply px-4 py-2 rounded-lg shadow-md transition-all duration-200 ease-in-out;
            @apply hover:scale-105 active:scale-95;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .btn-success {
            @apply bg-green-600 text-white hover:bg-green-700;
        }
        .btn-info {
            @apply bg-indigo-600 text-white hover:bg-indigo-700;
        }
        .btn-warning {
            @apply bg-yellow-500 text-white hover:bg-yellow-600;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700;
        }
        /* Input field styling */
        .input-field {
            @apply mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm;
        }
        /* Card styling */
        .card {
            @apply bg-white p-6 rounded-xl shadow-lg mb-6;
        }
        /* Message box for alerts */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none; /* Hidden by default */
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #message-box.show {
            display: block;
            opacity: 1;
        }
        #message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        #message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #message-box.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-8">PostgreSQL Database UI</h1>

        <!-- Message Box -->
        <div id="message-box" class="hidden"></div>

        <!-- Connection Status Card -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Database Connection</h2>
            <p id="connection-status" class="text-lg text-gray-600 mb-4">Checking connection...</p>
            <button id="connect-db-btn" class="btn btn-primary">Test Connection</button>
        </div>

        <!-- Actions Card -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Database Actions</h2>
            <div class="flex flex-wrap gap-4">
                <button id="create-table-btn" class="btn btn-info">Create Tables & Procedures</button>
                <button id="insert-sample-data-btn" class="btn btn-success">Insert Sample User Data</button>
                <button id="refresh-user-data-btn" class="btn btn-warning">Refresh User Data</button>
                <button id="refresh-admin-data-btn" class="btn btn-warning">Refresh Admin Data</button>
            </div>
        </div>

        <!-- Add New User Card -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add New User</h2>
            <form id="add-user-form" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Name:</label>
                    <input type="text" id="name" name="name" required class="input-field">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email:</label>
                    <input type="email" id="email" name="email" required class="input-field">
                </div>
                <button type="submit" class="btn btn-primary">Add User</button>
            </form>
        </div>

        <!-- User Data Display Card -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Current Users</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- User data will be loaded here -->
                        <tr>
                            <td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No data available. Click "Refresh User Data" to load.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add New Admin Card -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add New Admin</h2>
            <form id="add-admin-form" class="space-y-4">
                <div>
                    <label for="add-admin-id" class="block text-sm font-medium text-gray-700">ID (Optional, will auto-generate):</label>
                    <input type="text" id="add-admin-id" name="id" class="input-field" placeholder="Auto-generated if left empty">
                </div>
                <div>
                    <label for="add-admin-client-id" class="block text-sm font-medium text-gray-700">Client ID (Optional, will auto-generate):</label>
                    <input type="text" id="add-admin-client-id" name="client_id" class="input-field" placeholder="Auto-generated if left empty">
                </div>
                <div>
                    <label for="add-admin-username" class="block text-sm font-medium text-gray-700">Username:</label>
                    <input type="text" id="add-admin-username" name="username" required class="input-field">
                </div>
                <div>
                    <label for="add-admin-password" class="block text-sm font-medium text-gray-700">Password:</label>
                    <input type="password" id="add-admin-password" name="password" required class="input-field">
                </div>
                <div>
                    <label for="add-admin-name" class="block text-sm font-medium text-gray-700">Name:</label>
                    <input type="text" id="add-admin-name" name="name" required class="input-field">
                </div>
                <button type="submit" class="btn btn-primary">Add Admin</button>
            </form>
        </div>

        <!-- Update Admin Card -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Update Admin</h2>
            <form id="update-admin-form" class="space-y-4">
                <div>
                    <label for="update-admin-id" class="block text-sm font-medium text-gray-700">Admin ID (Required):</label>
                    <input type="text" id="update-admin-id" name="id" required class="input-field" placeholder="Enter Admin ID to update">
                </div>
                <div>
                    <label for="update-admin-client-id" class="block text-sm font-medium text-gray-700">Client ID (Required):</label>
                    <input type="text" id="update-admin-client-id" name="client_id" required class="input-field">
                </div>
                <div>
                    <label for="update-admin-username" class="block text-sm font-medium text-gray-700">Username (Required):</label>
                    <input type="text" id="update-admin-username" name="username" required class="input-field">
                </div>
                <div>
                    <label for="update-admin-password" class="block text-sm font-medium text-gray-700">Password (Required):</label>
                    <input type="password" id="update-admin-password" name="password" required class="input-field">
                </div>
                <div>
                    <label for="update-admin-name" class="block text-sm font-medium text-gray-700">Name (Required):</label>
                    <input type="text" id="update-admin-name" name="name" required class="input-field">
                </div>
                <button type="submit" class="btn btn-primary">Update Admin</button>
            </form>
        </div>

        <!-- Admin Data Display Card -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Current Admins</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Updated</th>
                        </tr>
                    </thead>
                    <tbody id="admins-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Admin data will be loaded here -->
                        <tr>
                            <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No data available. Click "Refresh Admin Data" to load.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const connectionStatusEl = document.getElementById('connection-status');
        const connectDbBtn = document.getElementById('connect-db-btn');
        const createTableBtn = document.getElementById('create-table-btn');
        const insertSampleDataBtn = document.getElementById('insert-sample-data-btn');
        const refreshUserDataBtn = document.getElementById('refresh-user-data-btn');
        const refreshAdminDataBtn = document.getElementById('refresh-admin-data-btn');
        const addUserForm = document.getElementById('add-user-form');
        const addAdminForm = document.getElementById('add-admin-form');
        const updateAdminForm = document.getElementById('update-admin-form');
        const usersTableBody = document.getElementById('users-table-body');
        const adminsTableBody = document.getElementById('admins-table-body');
        const messageBox = document.getElementById('message-box');

        // Function to show messages
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `show ${type}`; // Add 'show' class and type
            setTimeout(() => {
                messageBox.className = ''; // Remove classes to hide
            }, 3000); // Hide after 3 seconds
        }

        // Function to test database connection
        async function testDbConnection() {
            try {
                const response = await fetch('/api/connect');
                const data = await response.json();
                if (data.status === 'success') {
                    connectionStatusEl.textContent = data.message;
                    connectionStatusEl.classList.remove('text-red-600');
                    connectionStatusEl.classList.add('text-green-600');
                    showMessage(data.message, 'success');
                } else {
                    connectionStatusEl.textContent = data.message;
                    connectionStatusEl.classList.remove('text-green-600');
                    connectionStatusEl.classList.add('text-red-600');
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error connecting to DB:', error);
                connectionStatusEl.textContent = 'Failed to connect to database (Network Error).';
                connectionStatusEl.classList.remove('text-green-600');
                connectionStatusEl.classList.add('text-red-600');
                showMessage('Network error: Could not connect to Flask server.', 'error');
            }
        }

        // Function to create tables and procedures
        async function createTablesAndProcedures() {
            try {
                const response = await fetch('/api/create_table', { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success') {
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error creating tables/procedures:', error);
                showMessage('Network error: Could not create tables/procedures.', 'error');
            }
        }

        // Function to insert sample user data
        async function insertSampleUserData() {
            try {
                const response = await fetch('/api/insert_sample_data', { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success') {
                    showMessage(data.message, 'success');
                    fetchUserData(); // Refresh user data after inserting
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error inserting sample user data:', error);
                showMessage('Network error: Could not insert sample user data.', 'error');
            }
        }

        // Function to fetch and display user data
        async function fetchUserData() {
            try {
                const response = await fetch('/api/fetch_data');
                const result = await response.json();
                usersTableBody.innerHTML = ''; // Clear existing data

                if (result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                        `;
                        usersTableBody.appendChild(row);
                    });
                    showMessage('User data refreshed.', 'success');
                } else if (result.status === 'success' && result.data.length === 0) {
                    usersTableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No user data available.</td>
                        </tr>
                    `;
                    showMessage('No user data found.', 'info');
                } else {
                    usersTableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center">${result.message || 'Error fetching user data.'}</td>
                        </tr>
                    `;
                    showMessage(result.message || 'Failed to fetch user data.', 'error');
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
                usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center">Network error: Could not fetch user data.</td>
                    </tr>
                `;
                showMessage('Network error: Could not fetch user data.', 'error');
            }
        }

        // Function to fetch and display admin data
        async function fetchAdminData() {
            try {
                const response = await fetch('/api/fetch_admins');
                const result = await response.json();
                adminsTableBody.innerHTML = ''; // Clear existing data

                if (result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(admin => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${admin.Id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${admin.ClientId}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${admin.UserName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${admin.Name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${admin.Created ? new Date(admin.Created).toLocaleString() : ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${admin.Updated ? new Date(admin.Updated).toLocaleString() : ''}</td>
                        `;
                        adminsTableBody.appendChild(row);
                    });
                    showMessage('Admin data refreshed.', 'success');
                } else if (result.status === 'success' && result.data.length === 0) {
                    adminsTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No admin data available.</td>
                        </tr>
                    `;
                    showMessage('No admin data found.', 'info');
                } else {
                    adminsTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center">${result.message || 'Error fetching admin data.'}</td>
                        </tr>
                    `;
                    showMessage(result.message || 'Failed to fetch admin data.', 'error');
                }
            } catch (error) {
                console.error('Error fetching admin data:', error);
                adminsTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center">Network error: Could not fetch admin data.</td>
                    </tr>
                `;
                showMessage('Network error: Could not fetch admin data.', 'error');
            }
        }


        // Event Listeners for User Management
        connectDbBtn.addEventListener('click', testDbConnection);
        createTableBtn.addEventListener('click', createTablesAndProcedures);
        insertSampleDataBtn.addEventListener('click', insertSampleUserData);
        refreshUserDataBtn.addEventListener('click', fetchUserData);

        addUserForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;

            try {
                const response = await fetch('/api/insert_user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    showMessage(data.message, 'success');
                    addUserForm.reset(); // Clear form fields
                    fetchUserData(); // Refresh data after adding new user
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error adding user:', error);
                showMessage('Network error: Could not add user.', 'error');
            }
        });

        // Event Listeners for Admin Management
        refreshAdminDataBtn.addEventListener('click', fetchAdminData);

        addAdminForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const adminData = {
                id: document.getElementById('add-admin-id').value || undefined, // Allow optional ID
                client_id: document.getElementById('add-admin-client-id').value || undefined, // Allow optional Client ID
                username: document.getElementById('add-admin-username').value,
                password: document.getElementById('add-admin-password').value,
                name: document.getElementById('add-admin-name').value
            };

            try {
                const response = await fetch('/api/add_admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(adminData)
                });
                const data = await response.json();
                if (data.status === 'success') {
                    showMessage(data.message, 'success');
                    addAdminForm.reset();
                    fetchAdminData(); // Refresh admin data
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error adding admin:', error);
                showMessage('Network error: Could not add admin.', 'error');
            }
        });

        updateAdminForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const adminData = {
                id: document.getElementById('update-admin-id').value,
                client_id: document.getElementById('update-admin-client-id').value,
                username: document.getElementById('update-admin-username').value,
                password: document.getElementById('update-admin-password').value,
                name: document.getElementById('update-admin-name').value
            };

            try {
                const response = await fetch('/api/update_admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(adminData)
                });
                const data = await response.json();
                if (data.status === 'success') {
                    showMessage(data.message, 'success');
                    // No reset here, so user can see what they updated
                    fetchAdminData(); // Refresh admin data
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error updating admin:', error);
                showMessage('Network error: Could not update admin.', 'error');
            }
        });


        // Initial actions on page load
        document.addEventListener('DOMContentLoaded', () => {
            testDbConnection(); // Test connection on page load
            fetchUserData(); // Fetch existing user data on page load
            fetchAdminData(); // Fetch existing admin data on page load
        });
    </script>
</body>
</html>
